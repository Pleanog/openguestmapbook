<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>OpenGestMapBook</title>

    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="docs/images/favicon.ico"
    />

    <link rel="stylesheet" href="style.css" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
      integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
      integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
      crossorigin=""
    ></script>
  </head>

  <body>
    <div id="map"></div>

    <script>
      var lastSelectedPosition;
      var lastSendPosition;

      window.onload = function () {
        let listofvisitors = getDatainDatabase();

        drawVisitors(JSON.parse(listofvisitors));
      };

      function drawVisitors(listofvisitors) {
        listofvisitors.forEach(function (e, index) {
          L.marker([listofvisitors[index][1], listofvisitors[index][0]])
            .addTo(map)
            .bindPopup("ðŸš© " + listofvisitors[index][2]);
        });
      }

      function getDatainDatabase() {
        let request = new XMLHttpRequest();
        request.open("GET", "http://ogmb.kirtz.eu/entries.php", false); // false for synchronous request
        request.send(null);
        return request.responseText;
      }

      function saveDatainDatabase() {
        if (lastSelectedPosition == lastSendPosition) {
          console.log("verboten");
        } else {
          let formData = new FormData();

          let default_message = "hello hs kl";

          formData.append("long", lastSelectedPosition.lng);
          formData.append("lat", lastSelectedPosition.lat);
          formData.append("message", default_message);

          let request = new XMLHttpRequest();
          request.open("POST", "http://ogmb.kirtz.eu/create_entry.php");
          request.send(formData);

          lastSendPosition = lastSelectedPosition;

          L.marker([lastSelectedPosition.lat,lastSelectedPosition.lng])
            .addTo(map)
            .bindPopup("ðŸš© " + default_message);
        }
      }

      function savecurrentPosition(position) {
        lastSelectedPosition = position;
      }

      var map = L.map("map").setView([49.261101, 7.359755], 18);

      var tiles = L.tileLayer(
        "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",
        {
          maxZoom: 18,
          attribution:
            'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          id: "mapbox/streets-v11",
          tileSize: 512,
          zoomOffset: -1,
        }
      ).addTo(map);

      var marker = L.marker([49.261101, 7.359755])
        .addTo(map)
        .bindPopup("<b>Hochschule Kaiserslautern</b>")
        .openPopup();

      var popup = L.popup();

      function onMapClick(e) {
        savecurrentPosition(e.latlng);

        popup
          .setLatLng(e.latlng)
          .setContent(
            "<br>GÃ¤stebucheintrag hier speichern?<br><button onClick='saveDatainDatabase()' class='submit-button'>ja</button>"
          )
          .openOn(map);
      }

      map.on("click", onMapClick);
    </script>
  </body>
</html>
